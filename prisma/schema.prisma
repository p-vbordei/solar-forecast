// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========================================
// USER & AUTHENTICATION MODELS
// ========================================

// User and Authentication (deferred but schema ready)
model User {
  id             Int       @id @default(autoincrement())
  email          String    @unique
  name           String?
  role           UserRole  @default(USER)
  passwordHash   String?
  isActive       Boolean   @default(true)
  lastLoginAt    DateTime?
  preferences    Json?     // User preferences (theme, language, etc.)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  // Relations
  clientId       Int?
  client         Client?   @relation(fields: [clientId], references: [id])
  forecasts      Forecast[]
  alerts         Alert[]
  reports        Report[]
  auditLogs      AuditLog[]
  
  @@index([email])
  @@index([clientId])
  @@map("users")
}

enum UserRole {
  ADMIN
  MANAGER
  OPERATOR
  USER
  VIEWER
  API_SERVICE
}

// ========================================
// ORGANIZATION MODELS
// ========================================

// Client/Company
model Client {
  id             Int       @id @default(autoincrement())
  name           String
  code           String    @unique
  contactEmail   String?
  contactPhone   String?
  address        String?
  country        String?
  timezone       String    @default("UTC")
  currency       String    @default("EUR")
  isActive       Boolean   @default(true)
  contractStart  DateTime?
  contractEnd    DateTime?
  metadata       Json?     // Additional client-specific configuration
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  // Relations
  users          User[]
  locations      Location[]
  apiKeys        ApiKey[]
  
  @@index([code])
  @@map("clients")
}

// API Key Management for Python Worker & External Services
model ApiKey {
  id             String    @id @default(uuid())
  clientId       Int
  name           String
  key            String    @unique
  permissions    Json      // Array of allowed endpoints/operations
  isActive       Boolean   @default(true)
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  // Relations
  client         Client    @relation(fields: [clientId], references: [id])
  
  @@index([key])
  @@index([clientId])
  @@map("api_keys")
}

// ========================================
// SOLAR INSTALLATION MODELS
// ========================================

// Solar Installation Locations
model Location {
  id                Int       @id @default(autoincrement())
  clientId          Int
  name              String
  code              String    @unique
  latitude          Float
  longitude         Float
  timezone          String    @default("UTC")
  altitude          Float?
  
  // Location details
  address           String?
  city              String?
  region            String?
  country           String?
  
  // Technical specifications
  capacityMW        Float     // Nominal capacity in Megawatts
  actualCapacityMW  Float?    // Actual/derated capacity
  panelCount        Int?
  panelType         String?
  inverterCount     Int?
  inverterType      String?
  trackingSystem    TrackingType @default(FIXED)
  tiltAngle         Float?    // Degrees
  azimuthAngle      Float?    // Degrees
  
  // Dates
  installationDate  DateTime?
  commissioningDate DateTime?
  warrantyEndDate   DateTime?
  
  // Status
  status            LocationStatus @default(ACTIVE)
  lastMaintenance   DateTime?
  nextMaintenance   DateTime?
  
  // Performance benchmarks
  expectedYield     Float?    // kWh/kWp/year
  degradationRate   Float?    // Percentage per year
  performanceRatio  Float?    // PR target
  
  // Metadata
  metadata          Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  client            Client    @relation(fields: [clientId], references: [id])
  plants            Plant[]
  forecasts         Forecast[]
  production        Production[]
  alerts            Alert[]
  weatherData       WeatherData[]
  maintenanceLogs   MaintenanceLog[]
  
  @@index([clientId])
  @@index([code])
  @@index([status])
  @@index([latitude, longitude])
  @@map("locations")
}

enum LocationStatus {
  ACTIVE
  MAINTENANCE
  OFFLINE
  DECOMMISSIONED
  PLANNED
}

enum TrackingType {
  FIXED
  SINGLE_AXIS
  DUAL_AXIS
}

// Plant/Array within a Location (for large installations)
model Plant {
  id                String    @id @default(uuid())
  locationId        Int
  name              String
  code              String    @unique
  capacityMW        Float
  inverterIds       String[]  // Array of inverter serial numbers
  status            LocationStatus @default(ACTIVE)
  metadata          Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  location          Location  @relation(fields: [locationId], references: [id])
  
  @@index([locationId])
  @@index([code])
  @@map("plants")
}

// ========================================
// TIME SERIES DATA MODELS
// ========================================

// Forecast Data (TimescaleDB hypertable recommended)
model Forecast {
  id                String    @id @default(uuid())
  timestamp         DateTime
  locationId        Int
  
  // Forecast values
  powerMW           Float     // Forecasted power in MW
  energyMWh         Float?    // Forecasted energy in MWh
  
  // Confidence intervals
  powerMWLower      Float?    // Lower confidence bound
  powerMWUpper      Float?    // Upper confidence bound
  confidenceLevel   Float?    // Confidence percentage (0-100)
  
  // Forecast metadata
  modelType         ModelType
  modelVersion      String?
  modelId           String?   // Reference to MLModel
  horizonMinutes    Int       // Forecast horizon in minutes
  resolution        Int       // Resolution in minutes (15, 30, 60)
  runId             String?   // Forecast run identifier
  
  // Weather inputs used
  temperature       Float?
  ghi               Float?    // Global Horizontal Irradiance W/m²
  dni               Float?    // Direct Normal Irradiance W/m²
  dhi               Float?    // Diffuse Horizontal Irradiance W/m²
  cloudCover        Float?    // Percentage
  windSpeed         Float?    // m/s
  humidity          Float?    // Percentage
  pressure          Float?    // hPa
  weatherData       Json?     // Full weather context
  
  // Quality and validation
  qualityScore      Float?    // 0-1 quality indicator
  isValidated       Boolean   @default(false)
  validationNotes   String?
  
  // Tracking
  createdAt         DateTime  @default(now())
  createdBy         Int?
  
  // Relations
  location          Location  @relation(fields: [locationId], references: [id])
  user              User?     @relation(fields: [createdBy], references: [id])
  
  @@index([locationId, timestamp])
  @@index([timestamp])
  @@index([modelType])
  @@index([horizonMinutes])
  @@index([runId])
  @@map("forecasts")
}

enum ModelType {
  ML_LSTM
  ML_GRU
  ML_XGBOOST
  ML_RANDOMFOREST
  ML_PROPHET
  PHYSICAL
  HYBRID
  ENSEMBLE
  PERSISTENCE
  STATISTICAL
}

// Actual Production Data (TimescaleDB hypertable recommended)
model Production {
  id                String    @id @default(uuid())
  timestamp         DateTime
  locationId        Int
  
  // Production values (industry standard metrics)
  powerMW           Float     // Actual AC power in MW
  powerDCMW         Float?    // DC power in MW
  energyMWh         Float?    // Actual energy in MWh
  
  // Performance metrics
  capacityFactor    Float?    // Actual/Nominal capacity
  performanceRatio  Float?    // PR = Actual/Expected
  availability      Float?    // System availability percentage
  efficiency        Float?    // Conversion efficiency
  
  // Environmental conditions
  temperature       Float?    // Module temperature
  ambientTemp       Float?    // Ambient temperature
  ghi               Float?    // Global Horizontal Irradiance W/m²
  dni               Float?    // Direct Normal Irradiance W/m²
  dhi               Float?    // Diffuse Horizontal Irradiance W/m²
  windSpeed         Float?    // m/s
  windDirection     Float?    // Degrees
  
  // Electrical parameters
  voltage           Float?    // V
  current           Float?    // A
  frequency         Float?    // Hz
  powerFactor       Float?    // cos(φ)
  
  // Quality flags
  dataQuality       DataQuality @default(GOOD)
  dataSource        String?   // SCADA, Meter, Manual, etc.
  isValidated       Boolean   @default(false)
  validationNotes   String?
  
  // Downtime tracking
  downtimeMinutes   Int       @default(0)
  downtimeReason    String?
  
  // Relations
  location          Location  @relation(fields: [locationId], references: [id])
  
  @@index([locationId, timestamp])
  @@index([timestamp])
  @@index([dataQuality])
  @@map("production")
}

enum DataQuality {
  GOOD
  ESTIMATED
  INTERPOLATED
  POOR
  MISSING
  INVALID
}

// Weather Data (TimescaleDB hypertable recommended)
model WeatherData {
  id                String    @id @default(uuid())
  timestamp         DateTime
  locationId        Int
  
  // Basic weather metrics
  temperature       Float     // Celsius
  humidity          Float     // Percentage
  pressure          Float     // hPa
  windSpeed         Float     // m/s
  windDirection     Float     // Degrees
  cloudCover        Float     // Percentage (0-100)
  visibility        Float?    // km
  precipitation     Float?    // mm
  precipitationType String?   // rain, snow, etc.
  
  // Solar radiation components (industry standard)
  ghi               Float?    // Global Horizontal Irradiance W/m²
  dni               Float?    // Direct Normal Irradiance W/m²
  dhi               Float?    // Diffuse Horizontal Irradiance W/m²
  gti               Float?    // Global Tilted Irradiance W/m² (POA)
  extraterrestrial  Float?    // Extraterrestrial radiation W/m²
  
  // Solar position
  solarZenith       Float?    // Degrees
  solarAzimuth      Float?    // Degrees
  solarElevation    Float?    // Degrees
  airMass           Float?    // Air mass coefficient
  
  // Additional metrics
  albedo            Float?    // Surface reflectivity (0-1)
  soilingLoss       Float?    // Soiling loss percentage
  snowDepth         Float?    // cm
  moduleTemp        Float?    // Estimated module temperature
  
  // Source and quality
  source            String    // OpenWeather, Satellite, Station, etc.
  stationId         String?   // Weather station identifier
  dataQuality       DataQuality @default(GOOD)
  
  // Relations
  location          Location  @relation(fields: [locationId], references: [id])
  
  @@index([locationId, timestamp])
  @@index([timestamp])
  @@index([source])
  @@map("weather_data")
}

// ========================================
// FORECAST ACCURACY TRACKING
// ========================================

model ForecastAccuracy {
  id                String    @id @default(uuid())
  locationId        Int
  date              DateTime
  modelType         ModelType
  modelVersion      String?
  
  // Accuracy metrics (industry standard)
  mape              Float     // Mean Absolute Percentage Error
  rmse              Float     // Root Mean Square Error
  mae               Float     // Mean Absolute Error
  mbe               Float?    // Mean Bias Error
  r2                Float?    // R-squared
  
  // Skill scores
  skillScore        Float?    // Forecast skill vs persistence
  
  // By horizon (store as JSON array)
  accuracyByHorizon Json?     // Array of {horizon, mape, rmse, mae}
  
  // Sample counts
  sampleCount       Int
  validSamples      Int
  
  createdAt         DateTime  @default(now())
  
  @@unique([locationId, date, modelType, modelVersion])
  @@index([locationId])
  @@index([date])
  @@index([modelType])
  @@map("forecast_accuracy")
}

// ========================================
// ALERT & MONITORING MODELS
// ========================================

// Alert System
model Alert {
  id                String    @id @default(uuid())
  locationId        Int?
  userId            Int?
  
  // Alert details
  type              AlertType
  severity          AlertSeverity
  title             String
  message           String
  details           Json?
  
  // Thresholds that triggered alert
  thresholdValue    Float?
  actualValue       Float?
  
  // Status
  status            AlertStatus @default(ACTIVE)
  acknowledgedAt    DateTime?
  acknowledgedBy    Int?
  resolvedAt        DateTime?
  resolvedBy        Int?
  resolution        String?
  
  // Timestamps
  triggeredAt       DateTime  @default(now())
  expiresAt         DateTime?
  
  // Notification tracking
  notificationsSent Json?     // Array of notification methods used
  
  // Relations
  location          Location? @relation(fields: [locationId], references: [id])
  user              User?     @relation(fields: [userId], references: [id])
  
  @@index([locationId])
  @@index([status])
  @@index([severity])
  @@index([triggeredAt])
  @@index([type])
  @@map("alerts")
}

enum AlertType {
  PRODUCTION_LOW
  PRODUCTION_HIGH
  FORECAST_DEVIATION
  SYSTEM_OFFLINE
  MAINTENANCE_DUE
  WEATHER_WARNING
  DATA_QUALITY
  THRESHOLD_BREACH
  INVERTER_FAULT
  GRID_OUTAGE
  PERFORMANCE_DEGRADATION
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
  EMERGENCY
}

enum AlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
  EXPIRED
  SUPPRESSED
}

// ========================================
// MAINTENANCE & OPERATIONS
// ========================================

model MaintenanceLog {
  id                String    @id @default(uuid())
  locationId        Int
  
  // Maintenance details
  type              MaintenanceType
  category          String?   // Cleaning, Repair, Inspection, etc.
  description       String
  
  // Timing
  scheduledAt       DateTime
  startedAt         DateTime?
  completedAt       DateTime?
  duration          Int?      // Minutes
  
  // Impact
  productionLossMWh Float?
  downtime          Int?      // Minutes
  
  // Cost
  laborCost         Float?
  partsCost         Float?
  totalCost         Float?
  currency          String    @default("EUR")
  
  // Personnel
  performedBy       String?
  contractor        String?
  
  // Documentation
  notes             String?
  attachments       String[]  // URLs to documents/images
  
  // Status
  status            MaintenanceStatus @default(SCHEDULED)
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  location          Location  @relation(fields: [locationId], references: [id])
  
  @@index([locationId])
  @@index([scheduledAt])
  @@index([status])
  @@map("maintenance_logs")
}

enum MaintenanceType {
  PREVENTIVE
  CORRECTIVE
  PREDICTIVE
  CONDITION_BASED
  EMERGENCY
}

enum MaintenanceStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  POSTPONED
}

// ========================================
// REPORTING & ANALYTICS
// ========================================

// Reports
model Report {
  id                String    @id @default(uuid())
  userId            Int
  
  // Report details
  type              ReportType
  name              String
  description       String?
  
  // Configuration
  parameters        Json      // Report configuration
  filters           Json?     // Location IDs, date ranges, etc.
  
  // Schedule
  schedule          String?   // Cron expression
  isScheduled       Boolean   @default(false)
  lastRunAt         DateTime?
  nextRunAt         DateTime?
  
  // Output
  format            ReportFormat @default(PDF)
  outputUrl         String?
  fileSize          Int?      // Bytes
  
  // Distribution
  recipients        String[]  // Email addresses
  
  // Status
  status            ReportStatus @default(DRAFT)
  
  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  user              User      @relation(fields: [userId], references: [id])
  executions        ReportExecution[]
  
  @@index([userId])
  @@index([type])
  @@index([status])
  @@map("reports")
}

model ReportExecution {
  id                String    @id @default(uuid())
  reportId          String
  
  // Execution details
  startedAt         DateTime  @default(now())
  completedAt       DateTime?
  duration          Int?      // Seconds
  
  // Result
  status            ExecutionStatus
  outputUrl         String?
  fileSize          Int?      // Bytes
  recordCount       Int?
  
  // Error handling
  error             String?
  
  // Relations
  report            Report    @relation(fields: [reportId], references: [id])
  
  @@index([reportId])
  @@index([startedAt])
  @@map("report_executions")
}

enum ReportType {
  PRODUCTION_SUMMARY
  EFFICIENCY_ANALYSIS
  FORECAST_ACCURACY
  FINANCIAL_SUMMARY
  MAINTENANCE_REPORT
  COMPLIANCE_REPORT
  WEATHER_IMPACT
  LOCATION_COMPARISON
  CUSTOM
}

enum ReportFormat {
  PDF
  EXCEL
  CSV
  JSON
  HTML
}

enum ReportStatus {
  DRAFT
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// ========================================
// ML MODEL MANAGEMENT
// ========================================

// ML Model Registry
model MLModel {
  id                String    @id @default(uuid())
  name              String
  version           String
  type              ModelType
  
  // Model details
  description       String?
  algorithm         String?
  framework         String?   // TensorFlow, PyTorch, Scikit-learn, etc.
  hyperparameters   Json?
  features          String[]  // Input features used
  targetVariable    String?   // What it predicts
  
  // Performance metrics
  trainMetrics      Json?     // Training metrics
  validMetrics      Json?     // Validation metrics
  testMetrics       Json?     // Test metrics
  
  // Storage
  modelPath         String    // Path to model file
  artifactPath      String?   // Path to additional artifacts
  checksum          String?   // Model file checksum
  fileSize          Int?      // Bytes
  
  // Training data
  trainDataStart    DateTime?
  trainDataEnd      DateTime?
  trainSampleCount  Int?
  validSampleCount  Int?
  testSampleCount   Int?
  
  // Status
  status            ModelStatus @default(TRAINING)
  isDefault         Boolean   @default(false)
  isDeployed        Boolean   @default(false)
  
  // Deployment
  deployedAt        DateTime?
  deploymentUrl     String?   // Model serving endpoint
  
  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  trainedBy         String?   // User or service that trained it
  
  @@unique([name, version])
  @@index([type])
  @@index([status])
  @@index([isDefault])
  @@map("ml_models")
}

enum ModelStatus {
  TRAINING
  VALIDATING
  TESTING
  ACTIVE
  DEPRECATED
  FAILED
  ARCHIVED
}

// ========================================
// AUDIT & COMPLIANCE
// ========================================

model AuditLog {
  id                String    @id @default(uuid())
  userId            Int?
  
  // Action details
  action            String    // CREATE, UPDATE, DELETE, VIEW, EXPORT, etc.
  entity            String    // Table/Model name
  entityId          String?   // Record ID
  
  // Changes
  oldValues         Json?
  newValues         Json?
  
  // Context
  ipAddress         String?
  userAgent         String?
  sessionId         String?
  
  // Metadata
  timestamp         DateTime  @default(now())
  
  // Relations
  user              User?     @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([entity])
  @@index([timestamp])
  @@index([action])
  @@map("audit_logs")
}

// ========================================
// CONFIGURATION & SETTINGS
// ========================================

model SystemConfig {
  id                String    @id @default(uuid())
  key               String    @unique
  value             Json
  description       String?
  category          String?
  isPublic          Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([category])
  @@index([key])
  @@map("system_configs")
}